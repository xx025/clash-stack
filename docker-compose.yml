# Mihomo (Clash Meta) + MetaCubeXd 面板 + 订阅管理 一键栈
# 宿主机端口连续：7890 代理 / 7891 API / 7892 面板 / 7893 Sub-Store
# 使用: docker compose up -d（必须在项目目录执行，或把下面路径改成你的实际项目路径）

services:
  # Mihomo 代理核心 (Clash Meta 兼容，HTTP/SOCKS5 + REST API)
  mihomo:
    image: metacubex/mihomo:latest
    container_name: mihomo
    restart: always
    volumes:
      # 绝对路径：重启/任意目录执行都不会丢配置。若项目不在本机此路径，请改成你的实际路径
      - /home/user/workspace/clash-stack/config/mihomo/config.yaml:/root/.config/mihomo/config.yaml
    ports:
      - "7890:7890"
      - "7891:9090"
    environment:
      - TZ=Asia/Shanghai
    healthcheck:
      # 镜像无 wget，用 nc 检测 9090 端口（Alpine busybox 自带）
      test: ["CMD-SHELL", "nc -z 127.0.0.1 9090 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 15s

  # MetaCubeXd - Mihomo 官方 Web 控制面板
  metacubexd:
    image: dzlx/metacubexd
    container_name: metacubexd
    restart: always
    ports:
      - "7892:80"
    environment:
      - TZ=Asia/Shanghai
      - DEFAULT_BACKEND_URL=http://127.0.0.1:7891
    depends_on:
      mihomo:
        condition: service_healthy

  # Sub-Store - 多订阅组合与管理（合并、筛选、重命名、导出 Clash/Mihomo 等）
  sub-store:
    image: xream/sub-store:latest
    container_name: sub-store
    restart: always
    ports:
      # 前端 3000 对外；后端 3001 仅容器内，避免前后端同端口 EADDRINUSE
      - "7893:3000"
    volumes:
      - sub_store_data:/opt/app/data
    environment:
      - TZ=Asia/Shanghai
      - SUB_STORE_DOCKER=true
      - SUB_STORE_BACKEND_API_PORT=3001
      - SUB_STORE_FRONTEND_PORT=3000
      - SUB_STORE_BACKEND_PREFIX=true
      # API 路径，请改为随机字符串以提高安全性（访问：http://<IP>:7893/<此路径>）
      - SUB_STORE_FRONTEND_BACKEND_PATH=/api
      # 每 24 小时同步订阅（每天 0 点）
      - SUB_STORE_BACKEND_SYNC_CRON=0 0 * * *

volumes:
  sub_store_data:
