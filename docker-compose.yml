# Mihomo (Clash Meta) + MetaCubeXd 面板 + 订阅管理 一键栈
# 宿主机端口连续：7890 代理 / 7891 API / 7892 面板 / 7893 Sub-Store
# 使用: docker compose up -d

services:
  # Mihomo 代理核心 (Clash Meta 兼容，HTTP/SOCKS5 + REST API)
  mihomo:
    image: metacubex/mihomo:latest
    container_name: mihomo
    restart: unless-stopped
    volumes:
      # 仅挂载配置文件，避免覆盖镜像内自带的 geo 数据（否则每次启动会从 GitHub 下载，拖慢 1～3 分钟）
      - ./config/mihomo/config.yaml:/root/.config/mihomo/config.yaml
    ports:
      - "7890:7890"   # 混合代理 (HTTP + SOCKS5 共用)
      - "7891:9090"   # REST API (面板连接用)
    environment:
      - TZ=Asia/Shanghai
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://127.0.0.1:9090"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # MetaCubeXd - Mihomo 官方 Web 控制面板
  metacubexd:
    image: dzlx/metacubexd
    container_name: metacubexd
    restart: unless-stopped
    ports:
      - "7892:80"
    environment:
      - TZ=Asia/Shanghai
      # 浏览器访问面板时的默认 API 地址（对应宿主机端口 7891）
      - DEFAULT_BACKEND_URL=http://127.0.0.1:7891
    depends_on:
      mihomo:
        condition: service_healthy

  # Sub-Store - 多订阅组合与管理（合并、筛选、重命名、导出 Clash/Mihomo 等）
  sub-store:
    image: xream/sub-store:latest
    container_name: sub-store
    restart: unless-stopped
    ports:
      # 前端 3000 对外；后端 3001 仅容器内，避免前后端同端口 EADDRINUSE
      - "7893:3000"
    volumes:
      - sub_store_data:/opt/app/data
    environment:
      - TZ=Asia/Shanghai
      - SUB_STORE_DOCKER=true
      - SUB_STORE_BACKEND_API_PORT=3001
      - SUB_STORE_FRONTEND_PORT=3000
      - SUB_STORE_BACKEND_PREFIX=true
      # API 路径，请改为随机字符串以提高安全性（访问：http://<IP>:7893/<此路径>）
      - SUB_STORE_FRONTEND_BACKEND_PATH=/api
      # 每 24 小时同步订阅（每天 0 点）
      - SUB_STORE_BACKEND_SYNC_CRON=0 0 * * *

volumes:
  sub_store_data:
